<div class="boi-day-cao-popup">
  <div class="popup-header">
    <h2 mat-dialog-title>Bối dây cao - {{ data.quanDay.kyhieuquanday }}</h2>
    <button mat-icon-button (click)="onCancel()" class="close-button">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <div class="popup-content" *ngIf="!showKcsFailureForm">
    <form [formGroup]="boiDayCaoForm" (ngSubmit)="onSubmit()">
      
      <!-- Thông tin bảng vẽ -->
      <div class="section">
        <h3>Thông tin bảng vẽ</h3>
        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Công suất</mat-label>
            <input matInput [value]="data.quanDay.congsuat + ' KVA'" readonly>
          </mat-form-field>
          
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Điện áp</mat-label>
            <input matInput [value]="data.quanDay.dienap" readonly>
          </mat-form-field>
          
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>TBKT</mat-label>
            <input matInput [value]="data.quanDay.tbkt" readonly>
          </mat-form-field>
          
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Số bối dây</mat-label>
            <input matInput [value]="data.quanDay.soboiday" readonly>
          </mat-form-field>
        </div>
      </div>

      <mat-divider></mat-divider>

      <!-- Thông tin gia công -->
      <div class="section">
        <h3>Thông tin gia công</h3>
        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Quy cách dây *</mat-label>
            <input matInput formControlName="quy_cach_day" placeholder="Nhập quy cách dây">
          </mat-form-field>
          
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Số sợi chập *</mat-label>
            <input matInput type="number" formControlName="so_soi_day" min="1">
          </mat-form-field>
          
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Nhà sản xuất *</mat-label>
            <mat-select formControlName="nha_san_xuat" (selectionChange)="onManufacturerChange($event)">
              <mat-option *ngFor="let manufacturer of manufacturers" [value]="manufacturer.value">
                {{ manufacturer.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          
          <mat-form-field appearance="outline" class="form-field" *ngIf="boiDayCaoForm.get('nha_san_xuat')?.value === 'OTHER'">
            <mat-label>Tên nhà sản xuất khác</mat-label>
            <input matInput formControlName="nha_san_xuat_other" placeholder="Nhập tên nhà sản xuất">
          </mat-form-field>
          
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Ngày sản xuất *</mat-label>
            <input matInput [matDatepicker]="picker" formControlName="ngay_san_xuat">
            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
          </mat-form-field>
        </div>
      </div>

      <mat-divider></mat-divider>

      <!-- Thông tin kỹ thuật -->
      <div class="section">
        <h3>Thông tin kỹ thuật</h3>
        
        <!-- Chiều quấn dây -->
        <div class="form-row">
          <div class="radio-group">
            <label>Chiều quấn dây</label>
            <mat-radio-group formControlName="chieu_quan_day" class="radio-options">
              <mat-radio-button value="true">Trái</mat-radio-button>
              <mat-radio-button value="false">Phải</mat-radio-button>
            </mat-radio-group>
          </div>
          
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Máy quấn dây</mat-label>
            <input matInput formControlName="may_quan_day" placeholder="Nhập tên máy">
          </mat-form-field>
        </div>

        <!-- Độ dày -->
        <div class="form-row">
          <div class="thickness-section">
            <label>Độ dày (mm)</label>
            <div class="thickness-inputs">
              <div class="thickness-group">
                <label>Xung quanh</label>
                <div class="thickness-fields">
                  <mat-form-field appearance="outline" class="thickness-field">
                    <mat-label>2mm</mat-label>
                    <input matInput type="number" formControlName="xung_quanh_day_2" min="2" max="6">
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="thickness-field">
                    <mat-label>3mm</mat-label>
                    <input matInput type="number" formControlName="xung_quanh_day_3" min="2" max="6">
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="thickness-field">
                    <mat-label>4mm</mat-label>
                    <input matInput type="number" formControlName="xung_quanh_day_4" min="2" max="6">
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="thickness-field">
                    <mat-label>6mm</mat-label>
                    <input matInput type="number" formControlName="xung_quanh_day_6" min="2" max="6">
                  </mat-form-field>
                </div>
              </div>
              
              <div class="thickness-group">
                <label>Hai đầu</label>
                <div class="thickness-fields">
                  <mat-form-field appearance="outline" class="thickness-field">
                    <mat-label>2mm</mat-label>
                    <input matInput type="number" formControlName="hai_dau_day_2" min="2" max="6">
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="thickness-field">
                    <mat-label>3mm</mat-label>
                    <input matInput type="number" formControlName="hai_dau_day_3" min="2" max="6">
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="thickness-field">
                    <mat-label>4mm</mat-label>
                    <input matInput type="number" formControlName="hai_dau_day_4" min="2" max="6">
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="thickness-field">
                    <mat-label>6mm</mat-label>
                    <input matInput type="number" formControlName="hai_dau_day_6" min="2" max="6">
                  </mat-form-field>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Chu vi bối dây cao -->
        <div class="form-row">
          <div class="circumference-section">
            <label>Chu vi bối dây cao (mm)</label>
            <div class="circumference-fields">
              <mat-form-field appearance="outline" class="circumference-field">
                <mat-label>Pha 1</mat-label>
                <input matInput type="number" formControlName="chu_vi_bd_cao_1p" min="0">
              </mat-form-field>
              <mat-form-field appearance="outline" class="circumference-field">
                <mat-label>Pha 2</mat-label>
                <input matInput type="number" formControlName="chu_vi_bd_cao_2p" min="0">
              </mat-form-field>
              <mat-form-field appearance="outline" class="circumference-field">
                <mat-label>Pha 3</mat-label>
                <input matInput type="number" formControlName="chu_vi_bd_cao_3p" min="0">
              </mat-form-field>
            </div>
          </div>
        </div>

        <!-- Điện trở cao -->
        <div class="form-row">
          <div class="resistance-section">
            <label>Điện trở cao (Ω)</label>
            <div class="resistance-fields">
              <mat-form-field appearance="outline" class="resistance-field">
                <mat-label>Ra</mat-label>
                <input matInput type="number" formControlName="dien_tro_cao_ra" min="0">
              </mat-form-field>
              <mat-form-field appearance="outline" class="resistance-field">
                <mat-label>Rb</mat-label>
                <input matInput type="number" formControlName="dien_tro_cao_rb" min="0">
              </mat-form-field>
              <mat-form-field appearance="outline" class="resistance-field">
                <mat-label>Rc</mat-label>
                <input matInput type="number" formControlName="dien_tro_cao_rc" min="0">
              </mat-form-field>
            </div>
          </div>
        </div>

        <!-- Ghi chú -->
        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field full-width">
            <mat-label>Ghi chú</mat-label>
            <textarea matInput formControlName="ghi_chu" rows="3" placeholder="Nhập ghi chú (nếu có)"></textarea>
          </mat-form-field>
        </div>
      </div>
    </form>
  </div>

  <!-- KCS Failure Form -->
  <div class="kcs-failure-form" *ngIf="showKcsFailureForm">
    <h3>Báo cáo KCS Failure</h3>
    <form [formGroup]="kcsFailureForm">
      <mat-form-field appearance="outline" class="form-field full-width">
        <mat-label>ID Khâu sản xuất *</mat-label>
        <input matInput formControlName="id_khau_sanxuat" placeholder="Nhập ID khâu sản xuất">
      </mat-form-field>
      
      <mat-form-field appearance="outline" class="form-field full-width">
        <mat-label>Ghi chú *</mat-label>
        <textarea matInput formControlName="ghi_chu" rows="3" placeholder="Mô tả chi tiết vấn đề"></textarea>
      </mat-form-field>
    </form>
  </div>

  <!-- Action Buttons -->
  <div class="popup-actions">
    <button mat-button (click)="onCancel()" [disabled]="isLoading">
      Hủy
    </button>
    
    <button mat-button (click)="showKcsFailureFormDialog()" [disabled]="isLoading" class="kcs-button">
      <mat-icon>warning</mat-icon>
      Báo KCS Failure
    </button>
    
    <button mat-raised-button 
            color="primary" 
            (click)="onSubmit()" 
            [disabled]="!canSubmitForm() || isLoading"
            class="submit-button">
      <mat-spinner *ngIf="isLoading" diameter="20"></mat-spinner>
      <span *ngIf="!isLoading">Hoàn thành</span>
    </button>
  </div>

  <!-- KCS Failure Actions -->
  <div class="kcs-actions" *ngIf="showKcsFailureForm">
    <button mat-button (click)="hideKcsFailureForm()" [disabled]="isLoading">
      Quay lại
    </button>
    
    <button mat-raised-button 
            color="warn" 
            (click)="submitKcsFailure()" 
            [disabled]="!kcsFailureForm.valid || isLoading"
            class="submit-button">
      <mat-spinner *ngIf="isLoading" diameter="20"></mat-spinner>
      <span *ngIf="!isLoading">Gửi báo cáo</span>
    </button>
  </div>
</div>