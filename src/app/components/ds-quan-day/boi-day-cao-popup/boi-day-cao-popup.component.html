<div class="boi-day-cao-popup">
  <div class="popup-header">
    <h2 mat-dialog-title>Bối dây cao - {{ data.quanDay.kyhieuquanday }}</h2>
    <button mat-icon-button (click)="onCancel()" class="close-button">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <mat-dialog-content class="popup-content">
    <form [formGroup]="boiDayCaoForm" (ngSubmit)="onSubmit()">
      
      <!-- Thông tin cơ bản từ quấn dây -->
      <div class="info-section">
        <h3>Thông tin bảng vẽ</h3>
        <div class="info-grid">
          <div class="info-item">
            <span class="label">Công suất:</span>
            <span class="value">{{ data.quanDay.congsuat }} KVA</span>
          </div>
          <div class="info-item">
            <span class="label">TBKT:</span>
            <span class="value">{{ data.quanDay.tbkt }}</span>
          </div>
          <div class="info-item">
            <span class="label">Điện áp:</span>
            <span class="value">{{ data.quanDay.dienap }}</span>
          </div>
          <div class="info-item">
            <span class="label">Số bối dây:</span>
            <span class="value">{{ data.quanDay.soboiday }}</span>
          </div>
        </div>
      </div>

      <!-- Form nhập thông tin bối dây cao - Tối ưu và gọn gàng -->
      <div class="form-section">
        <div class="form-grid compact-grid">
          <!-- Dây và nhà sản xuất -->
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Quy cách dây</mat-label>
            <input matInput formControlName="quy_cach_day" placeholder="VD: 2.5mm²" (input)="onFormValueChange()">
            <mat-error *ngIf="boiDayCaoForm.get('quy_cach_day')?.hasError('required') && boiDayCaoForm.get('quy_cach_day')?.touched">
              Quy cách dây là bắt buộc
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Số sợi chập</mat-label>
            <input matInput type="number" formControlName="so_soi_day" placeholder="Nhập số sợi dây">
            <mat-error *ngIf="boiDayCaoForm.get('so_soi_day')?.hasError('required') && boiDayCaoForm.get('so_soi_day')?.touched">
              Số sợi dây là bắt buộc
            </mat-error>
            <mat-error *ngIf="boiDayCaoForm.get('so_soi_day')?.hasError('min') && boiDayCaoForm.get('so_soi_day')?.touched">
              Số sợi dây phải lớn hơn 0
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Nhà sản xuất</mat-label>
            <mat-select formControlName="nha_san_xuat" (selectionChange)="onManufacturerChange($event)">
              <mat-option *ngFor="let manufacturer of manufacturers" [value]="manufacturer.value">
                {{ manufacturer.name }}
              </mat-option>
              <mat-option value="OTHER">Khác</mat-option>
            </mat-select>
            <mat-error *ngIf="boiDayCaoForm.get('nha_san_xuat')?.hasError('required') && boiDayCaoForm.get('nha_san_xuat')?.touched">
              Nhà sản xuất là bắt buộc
            </mat-error>
          </mat-form-field>

          <!-- Input cho nhà sản xuất khác -->
          <mat-form-field appearance="outline" class="form-field other-manufacturer" 
                         [class.hidden]="boiDayCaoForm.get('nha_san_xuat')?.value !== 'OTHER'">
            <mat-label>Tên nhà sản xuất khác</mat-label>
            <input matInput formControlName="nha_san_xuat_other" placeholder="Nhập tên nhà sản xuất">
            <mat-error *ngIf="boiDayCaoForm.get('nha_san_xuat_other')?.hasError('required') && boiDayCaoForm.get('nha_san_xuat_other')?.touched">
              Tên nhà sản xuất là bắt buộc
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Ngày sản xuất</mat-label>
            <input matInput [matDatepicker]="pickerNgaySanXuat" formControlName="ngay_san_xuat">
            <mat-datepicker-toggle matSuffix [for]="pickerNgaySanXuat"></mat-datepicker-toggle>
            <mat-datepicker #pickerNgaySanXuat></mat-datepicker>
            <mat-error *ngIf="boiDayCaoForm.get('ngay_san_xuat')?.hasError('required') && boiDayCaoForm.get('ngay_san_xuat')?.touched">
              Ngày sản xuất là bắt buộc
            </mat-error>
          </mat-form-field>

          <!-- Kích thước cơ bản -->
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Chu vi khuôn (mm)</mat-label>
            <input matInput type="number" formControlName="chu_vi_khuon" placeholder="Nhập chu vi khuôn">
            <mat-error *ngIf="boiDayCaoForm.get('chu_vi_khuon')?.hasError('min') && boiDayCaoForm.get('chu_vi_khuon')?.touched">
              Chu vi khuôn phải lớn hơn hoặc bằng 0
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>KT bụng bd trước (mm)</mat-label>
            <input matInput type="number" formControlName="kt_bung_bd_truoc" placeholder="Nhập KT bụng bd trước">
            <mat-error *ngIf="boiDayCaoForm.get('kt_bung_bd_truoc')?.hasError('min') && boiDayCaoForm.get('kt_bung_bd_truoc')?.touched">
              KT bụng bd trước phải lớn hơn hoặc bằng 0
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Bụng bd sau (mm)</mat-label>
            <input matInput type="number" formControlName="bung_bd_sau" placeholder="Nhập bụng bd sau">
            <mat-error *ngIf="boiDayCaoForm.get('bung_bd_sau')?.hasError('min') && boiDayCaoForm.get('bung_bd_sau')?.touched">
              Bụng bd sau phải lớn hơn hoặc bằng 0
            </mat-error>
          </mat-form-field>

          <!-- Thông số kỹ thuật -->
          <div class="form-field">
            <label class="mat-label">Chiều quấn dây</label>
            <div class="radio-group">
              <mat-radio-group formControlName="chieu_quan_day" (change)="onFormValueChange()">
                <mat-radio-button [value]="true" class="radio-button">Trái</mat-radio-button>
                <mat-radio-button [value]="false" class="radio-button">Phải</mat-radio-button>
              </mat-radio-group>
            </div>
          </div>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Máy quấn dây</mat-label>
            <input matInput formControlName="may_quan_day" placeholder="Nhập máy quấn dây" (input)="onFormValueChange()">
            <mat-error *ngIf="boiDayCaoForm.get('may_quan_day')?.hasError('required') && boiDayCaoForm.get('may_quan_day')?.touched">
              Máy quấn dây là bắt buộc
            </mat-error>
          </mat-form-field>

          <!-- Độ dày -->
          <div class="form-field">
            <label class="mat-label">Độ dày (mm)</label>
            <div class="thickness-controls">
              <div class="thickness-group">
                <span class="thickness-label">Xung quanh:</span>
                <div class="thickness-inputs">
                  <input type="number" 
                         formControlName="xung_quanh_day_2" 
                         class="thickness-input"
                         min="2" 
                         max="6" 
                         placeholder="2"
                         value="2">
                  <input type="number" 
                         formControlName="xung_quanh_day_3" 
                         class="thickness-input"
                         min="2" 
                         max="6" 
                         placeholder="3"
                         value="3">
                  <input type="number" 
                         formControlName="xung_quanh_day_4" 
                         class="thickness-input"
                         min="2" 
                         max="6" 
                         placeholder="4"
                         value="4">
                  <input type="number" 
                         formControlName="xung_quanh_day_6" 
                         class="thickness-input"
                         min="2" 
                         max="6" 
                         placeholder="6"
                         value="6">
                </div>
              </div>
              <div class="thickness-group">
                <span class="thickness-label">Hai đầu:</span>
                <div class="thickness-inputs">
                  <input type="number" 
                         formControlName="hai_dau_day_2" 
                         class="thickness-input"
                         min="2" 
                         max="6" 
                         placeholder="2"
                         value="2">
                  <input type="number" 
                         formControlName="hai_dau_day_3" 
                         class="thickness-input"
                         min="2" 
                         max="6" 
                         placeholder="3"
                         value="3">
                  <input type="number" 
                         formControlName="hai_dau_day_4" 
                         class="thickness-input"
                         min="2" 
                         max="6" 
                         placeholder="4"
                         value="4">
                  <input type="number" 
                         formControlName="hai_dau_day_6" 
                         class="thickness-input"
                         min="2" 
                         max="6" 
                         placeholder="6"
                         value="6">
                </div>
              </div>
            </div>
          </div>

          <!-- Chu vi bối dây hạ trong -->
          <div class="form-field combined-field">
            <div class="field-label">Chu vi bối dây hạ trong (mm)</div>
            <div class="input-group">
              <mat-form-field appearance="outline" class="small-input">
                <mat-label>Pha 1</mat-label>
                <input matInput type="number" formControlName="chu_vi_bd_ha_trong_1p" placeholder="Pha 1">
                <mat-error *ngIf="boiDayCaoForm.get('chu_vi_bd_ha_trong_1p')?.hasError('required') && boiDayCaoForm.get('chu_vi_bd_ha_trong_1p')?.touched">
                  Chu vi bd Hạ trong 1p là bắt buộc
                </mat-error>
              </mat-form-field>
              
              <mat-form-field appearance="outline" class="small-input">
                <mat-label>Pha 2</mat-label>
                <input matInput type="number" formControlName="chu_vi_bd_ha_trong_2p" placeholder="Pha 2">
                <mat-error *ngIf="boiDayCaoForm.get('chu_vi_bd_ha_trong_2p')?.hasError('required') && boiDayCaoForm.get('chu_vi_bd_ha_trong_2p')?.touched">
                  Chu vi bd Hạ trong 2p là bắt buộc
                </mat-error>
              </mat-form-field>
              
              <mat-form-field appearance="outline" class="small-input">
                <mat-label>Pha 3</mat-label>
                <input matInput type="number" formControlName="chu_vi_bd_ha_trong_3p" placeholder="Pha 3">
                <mat-error *ngIf="boiDayCaoForm.get('chu_vi_bd_ha_trong_3p')?.hasError('required') && boiDayCaoForm.get('chu_vi_bd_ha_trong_3p')?.touched">
                  Chu vi bd Hạ trong 3p là bắt buộc
                </mat-error>
              </mat-form-field>
            </div>
          </div>

          <!-- Kích thước bối dây hạ ngoài -->
          <div class="form-field combined-field">
            <div class="field-label">KT bối dây hạ ngoài (mm)</div>
            <div class="input-group">
              <mat-form-field appearance="outline" class="small-input">
                <mat-label>Pha 1</mat-label>
                <input matInput type="number" formControlName="kt_bd_ha_ngoai_bv_1p" placeholder="Pha 1">
                <mat-error *ngIf="boiDayCaoForm.get('kt_bd_ha_ngoai_bv_1p')?.hasError('required') && boiDayCaoForm.get('kt_bd_ha_ngoai_bv_1p')?.touched">
                  KT bd Hạ ngoài BV 1p là bắt buộc
                </mat-error>
              </mat-form-field>
              
              <mat-form-field appearance="outline" class="small-input">
                <mat-label>Pha 2</mat-label>
                <input matInput type="number" formControlName="kt_bd_ha_ngoai_bv_2p" placeholder="Pha 2">
                <mat-error *ngIf="boiDayCaoForm.get('kt_bd_ha_ngoai_bv_2p')?.hasError('required') && boiDayCaoForm.get('kt_bd_ha_ngoai_bv_2p')?.touched">
                  KT bd Hạ ngoài BV 2p là bắt buộc
                </mat-error>
              </mat-form-field>
              
              <mat-form-field appearance="outline" class="small-input">
                <mat-label>Pha 3</mat-label>
                <input matInput type="number" formControlName="kt_bd_ha_ngoai_bv_3p" placeholder="Pha 3">
                <mat-error *ngIf="boiDayCaoForm.get('kt_bd_ha_ngoai_bv_3p')?.hasError('required') && boiDayCaoForm.get('kt_bd_ha_ngoai_bv_3p')?.touched">
                  KT bd Hạ ngoài BV 3p là bắt buộc
                </mat-error>
              </mat-form-field>
            </div>
          </div>

          <!-- Điện trở hạ -->
          <div class="form-field combined-field">
            <div class="field-label">Điện trở hạ (Ω)</div>
            <div class="input-group">
              <mat-form-field appearance="outline" class="small-input">
                <mat-label>Ra</mat-label>
                <input matInput type="number" formControlName="dien_tro_ha_ra" placeholder="Ra">
                <mat-error *ngIf="boiDayCaoForm.get('dien_tro_ha_ra')?.hasError('required') && boiDayCaoForm.get('dien_tro_ha_ra')?.touched">
                  Điện trở hạ Ra là bắt buộc
                </mat-error>
              </mat-form-field>
              
              <mat-form-field appearance="outline" class="small-input">
                <mat-label>Rb</mat-label>
                <input matInput type="number" formControlName="dien_tro_ha_rb" placeholder="Rb">
                <mat-error *ngIf="boiDayCaoForm.get('dien_tro_ha_rb')?.hasError('required') && boiDayCaoForm.get('dien_tro_ha_rb')?.touched">
                  Điện trở hạ Rb là bắt buộc
                </mat-error>
              </mat-form-field>
              
              <mat-form-field appearance="outline" class="small-input">
                <mat-label>Rc</mat-label>
                <input matInput type="number" formControlName="dien_tro_ha_rc" placeholder="Rc">
                <mat-error *ngIf="boiDayCaoForm.get('dien_tro_ha_rc')?.hasError('required') && boiDayCaoForm.get('dien_tro_ha_rc')?.touched">
                  Điện trở hạ Rc là bắt buộc
                </mat-error>
              </mat-form-field>
            </div>
          </div>

          <!-- Độ lệch điện trở -->
          <div class="form-field with-note">
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Độ lệch điện trở giữa các pha (%)</mat-label>
              <input matInput type="number" formControlName="do_lech_dien_tro_giua_cac_pha"
                     placeholder="Nhập độ lệch" max="2" min="0" step="0.1">
              <mat-error *ngIf="boiDayCaoForm.get('do_lech_dien_tro_giua_cac_pha')?.hasError('required') 
                                && boiDayCaoForm.get('do_lech_dien_tro_giua_cac_pha')?.touched">
                Độ lệch điện trở giữa các pha là bắt buộc
              </mat-error>
              <mat-error *ngIf="boiDayCaoForm.get('do_lech_dien_tro_giua_cac_pha')?.hasError('max') 
                                && boiDayCaoForm.get('do_lech_dien_tro_giua_cac_pha')?.touched">
                Độ lệch điện trở phải nhỏ hơn hoặc bằng 2%
              </mat-error>
            </mat-form-field>
            <span class="tc-note">(TC: ≤ 2%)</span>
          </div>
        </div>
      </div>

      <!-- Thông tin gia công -->
      <div class="info-section">
        <h3>Thông tin gia công</h3>
        <div class="info-grid">
          <div class="info-item">
            <span class="label">Người gia công:</span>
            <span class="value">{{ currentUser?.firstName + ' ' + currentUser?.lastName || 'Unknown' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Ngày gia công:</span>
            <span class="value">{{ currentDate | date:'dd/MM/yyyy HH:mm' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Ký hiệu BV:</span>
            <span class="value">{{ data.quanDay.kyhieuquanday }}-066</span>
          </div>
          <div class="info-item">
            <span class="label">Ngày tạo:</span>
            <span class="value">{{ currentDate | date:'dd/MM/yyyy' }}</span>
          </div>
        </div>
      </div>
    </form>
  </mat-dialog-content>

  <mat-dialog-actions class="popup-actions">
    <button mat-button (click)="onCancel()" [disabled]="isLoading">
      Hủy
    </button>
    
    <button mat-raised-button 
            color="primary" 
            (click)="onSubmit()" 
            [disabled]="!canSubmitForm()"
            class="submit-button">
      <mat-spinner diameter="20" *ngIf="isLoading"></mat-spinner>
      <span *ngIf="!isLoading">Hoàn thành</span>
    </button>
  </mat-dialog-actions>

  <!-- Form KCS Failure Dialog -->
  <div class="kcs-failure-overlay" *ngIf="showKcsFailureForm">
    <div class="kcs-failure-dialog">
      <div class="kcs-failure-header">
        <h3>KCS Quality Check Failure</h3>
        <button mat-icon-button (click)="hideKcsFailureForm()" class="close-button">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      
      <div class="kcs-failure-content">
        <form [formGroup]="kcsFailureForm" (ngSubmit)="submitKcsFailure()">
          <div class="form-field">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Khẩu sản xuất</mat-label>
              <input matInput formControlName="id_khau_sanxuat" placeholder="Nhập khẩu sản xuất">
              <mat-error *ngIf="kcsFailureForm.get('id_khau_sanxuat')?.hasError('required') && kcsFailureForm.get('id_khau_sanxuat')?.touched">
                Khẩu sản xuất là bắt buộc
              </mat-error>
            </mat-form-field>
          </div>
          
          <div class="form-field">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Ghi chú</mat-label>
              <textarea matInput formControlName="ghi_chu" placeholder="Nhập lý do không đạt chất lượng" rows="3"></textarea>
              <mat-error *ngIf="kcsFailureForm.get('ghi_chu')?.hasError('required') && kcsFailureForm.get('ghi_chu')?.touched">
                Ghi chú là bắt buộc
              </mat-error>
            </mat-form-field>
          </div>
          
          <div class="kcs-failure-actions">
            <button mat-button type="button" (click)="hideKcsFailureForm()" [disabled]="isLoading">
              Hủy
            </button>
            <button mat-raised-button 
                    color="warn" 
                    type="submit" 
                    [disabled]="!kcsFailureForm.valid || isLoading">
              <mat-spinner diameter="20" *ngIf="isLoading"></mat-spinner>
              <span *ngIf="!isLoading">Gửi KCS Failure</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
