<div class="dialog-container">
  <h2 mat-dialog-title>
    <mat-icon>{{isEdit ? 'edit' : 'person_add'}}</mat-icon>
    {{isEdit ? 'Chỉnh sửa Người dùng' : 'Thêm Người dùng Mới'}}
  </h2>

  <mat-dialog-content>
    <form [formGroup]="userForm" class="user-form">
      <div class="form-row">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Username *</mat-label>
          <input matInput formControlName="username" placeholder="Nhập username">
          <mat-error>{{getErrorMessage('username')}}</mat-error>
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Email *</mat-label>
          <input matInput formControlName="email" placeholder="Nhập email">
          <mat-error>{{getErrorMessage('email')}}</mat-error>
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Họ và Tên *</mat-label>
          <input matInput formControlName="fullName" placeholder="Nhập họ và tên">
          <mat-error>{{getErrorMessage('fullName')}}</mat-error>
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Số điện thoại</mat-label>
          <input matInput formControlName="phone" placeholder="Nhập số điện thoại">
        </mat-form-field>

        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Phòng ban</mat-label>
          <input matInput formControlName="department" placeholder="Nhập phòng ban">
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Chức vụ</mat-label>
          <input matInput formControlName="position" placeholder="Nhập chức vụ">
        </mat-form-field>
      </div>

      <div class="form-row">
        <div class="roles-section">
          <h4>Vai trò *</h4>
          <p class="roles-description">Chọn vai trò cho người dùng này</p>
          <div class="roles-list">
            <mat-checkbox 
              *ngFor="let role of data.roles" 
              [checked]="isRoleSelected(role.name)"
              (change)="onRoleSelectionChange(role.name, $event.checked)"
              class="role-checkbox">
              <div class="role-info">
                <span class="role-name">{{role.displayName}}</span>
                <span class="role-description">{{role.description}}</span>
              </div>
            </mat-checkbox>
          </div>
          <div *ngIf="selectedRoles.length === 0" class="error-message">
            Vui lòng chọn ít nhất một vai trò
          </div>
        </div>
      </div>

      <div class="form-row">
        <mat-checkbox formControlName="isActive" class="status-checkbox">
          Tài khoản hoạt động
        </mat-checkbox>
      </div>

      <div class="form-row" *ngIf="!isEdit">
        <div class="auth-option-section">
          <mat-checkbox formControlName="createWithAuth" class="auth-checkbox">
            <div class="auth-option-info">
              <span class="auth-option-title">Tạo với Firebase Authentication</span>
              <span class="auth-option-description">
                Tạo Firebase Auth account ngay từ đầu để có thể đổi mật khẩu trực tiếp sau này
              </span>
            </div>
          </mat-checkbox>
        </div>
      </div>

      <!-- Password fields - only show when createWithAuth is checked -->
      <div class="form-row" *ngIf="!isEdit && userForm.get('createWithAuth')?.value">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Mật khẩu *</mat-label>
          <input matInput 
                 [type]="hidePassword ? 'password' : 'text'"
                 formControlName="password" 
                 placeholder="Nhập mật khẩu">
          <button mat-icon-button 
                  matSuffix 
                  type="button"
                  (click)="hidePassword = !hidePassword"
                  [attr.aria-label]="'Hide password'"
                  [attr.aria-pressed]="hidePassword">
            <mat-icon>{{hidePassword ? 'visibility_off' : 'visibility'}}</mat-icon>
          </button>
          <mat-error>{{getErrorMessage('password')}}</mat-error>
        </mat-form-field>
      </div>

      <div class="form-row" *ngIf="!isEdit && userForm.get('createWithAuth')?.value">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Xác nhận mật khẩu *</mat-label>
          <input matInput 
                 [type]="hideConfirmPassword ? 'password' : 'text'"
                 formControlName="confirmPassword" 
                 placeholder="Nhập lại mật khẩu">
          <button mat-icon-button 
                  matSuffix 
                  type="button"
                  (click)="hideConfirmPassword = !hideConfirmPassword"
                  [attr.aria-label]="'Hide password'"
                  [attr.aria-pressed]="hideConfirmPassword">
            <mat-icon>{{hideConfirmPassword ? 'visibility_off' : 'visibility'}}</mat-icon>
          </button>
          <mat-error>{{getErrorMessage('confirmPassword')}}</mat-error>
        </mat-form-field>
      </div>

      <!-- Password requirements -->
      <div class="form-row" *ngIf="!isEdit && userForm.get('createWithAuth')?.value">
        <div class="password-requirements">
          <h4>Yêu cầu mật khẩu:</h4>
          <ul>
            <li>Ít nhất 6 ký tự</li>
            <li>Chứa ít nhất 1 chữ hoa</li>
            <li>Chứa ít nhất 1 chữ thường</li>
            <li>Chứa ít nhất 1 số</li>
          </ul>
        </div>
      </div>
    </form>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-button (click)="onCancel()" class="cancel-button">
      <mat-icon>close</mat-icon>
      Hủy
    </button>
    <button mat-raised-button 
            color="primary" 
            (click)="onSubmit()"
            [disabled]="!userForm.valid || selectedRoles.length === 0"
            class="submit-button">
      <mat-icon>{{isEdit ? 'save' : 'add'}}</mat-icon>
      {{isEdit ? 'Cập nhật' : 'Tạo mới'}}
    </button>
  </mat-dialog-actions>
</div>
